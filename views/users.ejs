<%- include('./partials/header.ejs'); %>
  <div class="manageUser-container">
    <div id="title">
      <h2>Manage Users</h2>
    </div>

    <div class="new-message-container new-user">
      <a href="#" onclick="openModal()">+</a>
    </div>

    <div id="users-table">
      <table>
        <thead>
          <tr>
            <th>Name</th>
            <th>Email</th>
            <th>Manage</th>
          </tr>
        </thead>
        <tbody id="users-table">
          <% if (allusers && allusers.length> 0) { %>
            <% allusers.forEach(user=> { %>
              <tr id="<%=user._id%>">
                <td class="name">
                  <img src="./uploads/avatars/<%= user.avatar %>" />
                  <span>
                    <%= user.name %>
                  </span>
                </td>
                <td>
                  <%= user.email %>
                </td>
                <td class="manage">
                  <img src="./images/trash.png" alt="Delete" onclick="attemptDeleteUser('<%=user._id%>')" />
                </td>
              </tr>
              <% }) %>
                <% } %>
        </tbody>
      </table>
    </div>
  </div>
  <%- include('./partials/add-user-modal.ejs'); %>
  
  <script>
    // Toast messages
    const deleteToast = Toastify({
      text: "User was deleted successfully!",
      duration: 3000,
    });
  
    const deleteErrorToast = Toastify({
      text: "Could not delete the user!",
      duration: 3000,
    });
  
    // confirmation before deleting
    async function attemptDeleteUser(id) {
      const confirmation = confirm("Are you sure you want to delete this user?");
      if (confirmation) {
        deleteUser(id); 
      }
    }
  
    async function deleteUser(id) {
      try {
        const response = await fetch(`/users/${id}`, {
          method: "DELETE"
        });
  
        let result = await response.json();
  
        if (result.errors) {
          deleteErrorToast.showToast();
        } else {
          const element = document.getElementById(id);
          element ? element.remove() : console.error('Element not found:', id);
          deleteToast.showToast();
        }
      } catch (error) {
        console.error('Error:', error);
      }
    }
  </script>
  
    </body>

    </html>